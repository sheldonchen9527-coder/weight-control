<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä½“é‡è®°å½•å°å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f6fa;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 12px;
      text-align: center;
    }
    .card {
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      background: #ffffff;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    .btn-row {
      margin: 8px 0 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button:active { transform: scale(0.98); }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #saveBtn { background: #007aff; color: #fff; }
    #saveTargetBtn { background: #34c759; color: #fff; }
    #clearBtn { background: #f2f2f7; color: #333; }
    #status {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #666;
    }
    .stat-line {
      margin: 2px 0;
      font-size: 0.9rem;
    }
    .muted {
      color: #666;
      font-size: 0.85rem;
    }
    canvas {
      width: 100%;
      max-width: 600px;
      height: 260px;
    }
    #targetDiff.target-above {
      color: #d6336c;
    }
    #targetDiff.target-below {
      color: #2f9e44;
    }
    /* æ‰“é’ˆæé†’æ ·å¼ */
    #injectReminder {
      font-size: 0.95rem;
    }
    #injectReminder.inject-today {
      color: #d6336c;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>ä½“é‡è®°å½•å°å·¥å…·</h1>

  <!-- æ¯å‘¨ä¸‰æ‰“é’ˆæé†’ -->
  <div class="card">
    <div id="injectReminder">ğŸ’‰ åŠ è½½ä¸­...</div>
  </div>

  <div class="card">
    <label for="weightInput">ä»Šå¤©ä½“é‡ï¼ˆkgï¼‰ï¼š</label>
    <input type="number" id="weightInput" step="0.1" placeholder="ä¾‹å¦‚ 63.5" />

    <label for="targetInput" style="display:block;margin-top:6px;">ç›®æ ‡ä½“é‡ï¼ˆkgï¼‰ï¼š</label>
    <input type="number" id="targetInput" step="0.1" placeholder="ä¾‹å¦‚ 60" />

    <div class="btn-row">
      <button id="saveBtn">ä¿å­˜ä»Šå¤©</button>
      <button id="saveTargetBtn">ä¿å­˜ç›®æ ‡</button>
      <button id="clearBtn">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
    </div>

    <div id="status" class="muted"></div>
  </div>

  <div class="card">
    <h2 style="font-size:1.05rem;margin-top:0;">ç»Ÿè®¡</h2>
    <div id="stats">
      <div class="stat-line">è®°å½•å¤©æ•°ï¼š<span id="daysCount">0</span></div>
      <div class="stat-line">æœ€è½»ä½“é‡ï¼š<span id="minWeight">-</span></div>
      <div class="stat-line">æœ€é‡ä½“é‡ï¼š<span id="maxWeight">-</span></div>
      <div class="stat-line">å¹³å‡ä½“é‡ï¼š<span id="avgWeight">-</span></div>
      <div class="stat-line">æ€»ä½“å˜åŒ–ï¼š<span id="overallChange">-</span></div>
      <div class="stat-line">è·ç¦»ç›®æ ‡ï¼ˆå½“å‰ - ç›®æ ‡ï¼‰ï¼š<span id="targetDiff">æœªè®¾ç½®</span></div>
      <div class="stat-line">æœ€è¿‘ 7 å¤©å˜åŒ–ï¼š<span id="weekChange">-</span></div>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1.05rem;margin-top:0;">æœ€è¿‘ 30 å¤©æŠ˜çº¿å›¾</h2>
    <p class="muted">æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸ä¼šä¸Šä¼ ç½‘ç»œã€‚</p>
    <canvas id="chartCanvas"></canvas>
  </div>

  <script>
    const STORAGE_KEY = "weight-tracker-data-v1";
    const TARGET_KEY  = "weight-tracker-target-v1";

    function loadData() {
      try {
        const txt = localStorage.getItem(STORAGE_KEY);
        if (!txt) return [];
        const arr = JSON.parse(txt);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadTarget() {
      try {
        const txt = localStorage.getItem(TARGET_KEY);
        const v = parseFloat(txt);
        return isNaN(v) ? null : v;
      } catch {
        return null;
      }
    }

    function saveTarget(v) {
      localStorage.setItem(TARGET_KEY, String(v));
    }

    function formatDate(d) {
      return d.getFullYear() + "-" +
             String(d.getMonth()+1).padStart(2,"0") + "-" +
             String(d.getDate()).padStart(2,"0");
    }

    function renderStats(data) {
      const daysCountEl     = document.getElementById("daysCount");
      const minWeightEl     = document.getElementById("minWeight");
      const maxWeightEl     = document.getElementById("maxWeight");
      const avgWeightEl     = document.getElementById("avgWeight");
      const overallChangeEl = document.getElementById("overallChange");
      const weekChangeEl    = document.getElementById("weekChange");
      const targetDiffEl    = document.getElementById("targetDiff");

      if (!data.length) {
        daysCountEl.textContent     = "0";
        minWeightEl.textContent     = "-";
        maxWeightEl.textContent     = "-";
        avgWeightEl.textContent     = "-";
        overallChangeEl.textContent = "-";
        weekChangeEl.textContent    = "-";
        targetDiffEl.textContent    = "æœªè®¾ç½®";
        targetDiffEl.classList.remove("target-above", "target-below");
        drawChart([]);
        return;
      }

      data.sort((a,b) => a.date.localeCompare(b.date));
      const weights = data.map(d => d.weight);

      const sum = weights.reduce((a,b) => a + b, 0);
      const avg = sum / weights.length;
      const min = Math.min(...weights);
      const max = Math.max(...weights);
      const overallChange = weights[weights.length-1] - weights[0];

      daysCountEl.textContent     = String(data.length);
      minWeightEl.textContent     = min.toFixed(1) + " kg";
      maxWeightEl.textContent     = max.toFixed(1) + " kg";
      avgWeightEl.textContent     = avg.toFixed(1) + " kg";
      overallChangeEl.textContent = (overallChange >= 0 ? "+" : "") + overallChange.toFixed(1) + " kg";

      // ç›®æ ‡å·®å€¼
      const target = loadTarget();
      targetDiffEl.classList.remove("target-above", "target-below");
      if (target != null) {
        const current = weights[weights.length-1];
        const diff = current - target;
        targetDiffEl.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(1) + " kg";
        if (diff > 0.05) {
          targetDiffEl.classList.add("target-above");
        } else if (diff < -0.05) {
          targetDiffEl.classList.add("target-below");
        }
      } else {
        targetDiffEl.textContent = "æœªè®¾ç½®";
      }

      // æœ€è¿‘ 7 å¤©
      if (data.length >= 7) {
        const base = weights[weights.length-7];
        const last = weights[weights.length-1];
        const diff = last - base;
        weekChangeEl.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(1) + " kg";
      } else {
        weekChangeEl.textContent = "è®°å½•å°‘äº 7 å¤©";
      }

      drawChart(data.slice(-30));
    }

    function drawChart(data) {
      const canvas = document.getElementById("chartCanvas");
      const ctx = canvas.getContext("2d");
      const width  = canvas.clientWidth;
      const height = canvas.clientHeight;

      canvas.width  = width * window.devicePixelRatio;
      canvas.height = height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      ctx.clearRect(0,0,width,height);

      if (!data.length) {
        ctx.fillStyle = "#666";
        ctx.font = "14px -apple-system";
        ctx.fillText("æš‚æ— æ•°æ®ï¼Œå…ˆè®°å½•å‡ å¤©è¯•è¯•å§ï½", 10, 24);
        return;
      }

      const paddingLeft   = 34;
      const paddingRight  = 10;
      const paddingTop    = 10;
      const paddingBottom = 50; // ç»™æ—¥æœŸç•™ç©ºé—´

      const xs = data.map((_,i) => i);
      const ys = data.map(d => d.weight);
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const rangeY = maxY - minY || 1;
      const maxX = xs.length - 1 || 1;

      function xToPx(x) {
        return paddingLeft + (x / maxX) * (width - paddingLeft - paddingRight);
      }

      function yToPx(y) {
        return paddingTop + (1 - (y - minY) / rangeY) *
               (height - paddingTop - paddingBottom);
      }

      // åæ ‡è½´
      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, paddingTop);
      ctx.lineTo(paddingLeft, height - paddingBottom);
      ctx.lineTo(width - paddingRight, height - paddingBottom);
      ctx.stroke();

      // æŠ˜çº¿
      ctx.strokeStyle = "#007aff";
      ctx.lineWidth = 2;
      ctx.beginPath();
      xs.forEach((x,i) => {
        const px = xToPx(x);
        const py = yToPx(ys[i]);
        if (i === 0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      });
      ctx.stroke();

      // å°åœ†ç‚¹
      ctx.fillStyle = "#007aff";
      xs.forEach((x,i) => {
        const px = xToPx(x);
        const py = yToPx(ys[i]);
        ctx.beginPath();
        ctx.arc(px,py,3,0,Math.PI*2);
        ctx.fill();
      });

      // y è½´æ•°å­—
      ctx.fillStyle = "#666";
      ctx.font = "11px -apple-system";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText(minY.toFixed(1), paddingLeft - 4, yToPx(minY));
      if (maxY !== minY) {
        ctx.fillText(maxY.toFixed(1), paddingLeft - 4, yToPx(maxY));
      }

      // x è½´æ—¥æœŸï¼šæ¯ä¸ªç‚¹ä¸‹é¢å†™ MM-DD
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.font = "10px -apple-system";
      data.forEach((d, i) => {
        const label = d.date.slice(5); // åªæ˜¾ç¤º æœˆ-æ—¥
        const px = xToPx(i);
        const py = height - paddingBottom + 2;
        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(-Math.PI / 4); // æ–œç€ä¸€ç‚¹ï¼Œé¿å…å¤ªæŒ¤
        ctx.fillText(label, 0, 0);
        ctx.restore();
      });
    }

    function renderInjectionReminder() {
      const el = document.getElementById("injectReminder");
      const today = new Date();
      const day = today.getDay(); // 0=å‘¨æ—¥,1=å‘¨ä¸€,...,3=å‘¨ä¸‰

      if (!el) return;

      if (day === 3) {
        el.textContent = "ğŸ’‰ ä»Šå¤©æ˜¯å‘¨ä¸‰ï¼Œè®°å¾—æ‰“é’ˆ";
        el.classList.add("inject-today");
      } else {
        const diff = (3 - day + 7) % 7;
        const days = diff === 0 ? 7 : diff;
        el.textContent = `ğŸ’‰ è·ç¦»ä¸‹ä¸€ä¸ªå‘¨ä¸‰è¿˜æœ‰ ${days} å¤©`;
        el.classList.remove("inject-today");
      }
    }

    function init() {
      const input        = document.getElementById("weightInput");
      const targetInput  = document.getElementById("targetInput");
      const saveBtn      = document.getElementById("saveBtn");
      const saveTargetBtn= document.getElementById("saveTargetBtn");
      const clearBtn     = document.getElementById("clearBtn");
      const statusEl     = document.getElementById("status");

      renderInjectionReminder(); // æ¯æ¬¡æ‰“å¼€é¡µé¢æ—¶æ›´æ–°æ‰“é’ˆæé†’

      let data = loadData();
      renderStats(data);

      const todayStr = formatDate(new Date());
      const todayRecord = data.find(d => d.date === todayStr);

      // å¦‚æœä»Šå¤©å·²ç»æœ‰è®°å½•ï¼šå¡«ä¸Šä½“é‡+ç¦ç”¨ä¿å­˜æŒ‰é’®
      if (todayRecord) {
        if (input) input.value = todayRecord.weight;
        if (saveBtn) {
          saveBtn.disabled = true;
        }
        if (statusEl) {
          statusEl.textContent = `ä»Šå¤©å·²ç»è®°å½•è¿‡ä½“é‡ï¼š${todayRecord.weight.toFixed(1)} kg`;
        }
      }

      // åŠ è½½ç›®æ ‡ä½“é‡
      const target = loadTarget();
      if (target != null && !isNaN(target)) {
        targetInput.value = target.toFixed(1);
      }

      saveBtn.addEventListener("click", () => {
        if (saveBtn.disabled) {
          statusEl.textContent = "ä»Šå¤©å·²ç»è®°å½•è¿‡äº†ï¼Œä¸èƒ½é‡å¤ä¿å­˜ã€‚";
          return;
        }
        const v = parseFloat(input.value);
        if (isNaN(v)) {
          statusEl.textContent = "è¯·è¾“å…¥æ•°å­—æ ¼å¼çš„ä½“é‡ï¼Œä¾‹å¦‚ 63.5";
          return;
        }
        const today = formatDate(new Date());
        const existing = data.find(d => d.date === today);
        if (existing) {
          // å·²æœ‰è®°å½•åˆ™ä¸å…è®¸è¦†ç›–
          statusEl.textContent = "ä»Šå¤©å·²ç»æœ‰è®°å½•ï¼Œæ— æ³•å†æ¬¡ä¿å­˜ã€‚";
          saveBtn.disabled = true;
          return;
        } else {
          data.push({ date: today, weight: v });
        }
        data.sort((a,b)=>a.date.localeCompare(b.date));
        saveData(data);
        renderStats(data);
        statusEl.textContent = `å·²ä¿å­˜ ${today}ï¼š${v.toFixed(1)} kg`;
        saveBtn.disabled = true; // ä¿å­˜æˆåŠŸåç¦ç”¨
      });

      saveTargetBtn.addEventListener("click", () => {
        const v = parseFloat(targetInput.value);
        if (isNaN(v)) {
          statusEl.textContent = "è¯·è¾“å…¥æ•°å­—æ ¼å¼çš„ç›®æ ‡ä½“é‡ï¼Œä¾‹å¦‚ 60";
          return;
        }
        saveTarget(v);
        const latestData = loadData();
        renderStats(latestData);
        statusEl.textContent = `å·²ä¿å­˜ç›®æ ‡ä½“é‡ï¼š${v.toFixed(1)} kg`;
      });

      clearBtn.addEventListener("click", () => {
        if (!confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
        data = [];
        saveData(data);
        renderStats(data);
        input.value = "";
        statusEl.textContent = "æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ã€‚";
        saveBtn.disabled = false; // æ¸…ç©ºåå…è®¸é‡æ–°è®°å½•
      });
    }

    window.addEventListener("load", init);
    window.addEventListener("resize", () => {
      const data = loadData();
      renderStats(data);
    });
  </script>
</body>
</html>