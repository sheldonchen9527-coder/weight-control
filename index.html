<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>体重记录小工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f6fa;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 12px;
      text-align: center;
    }
    .card {
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      background: #ffffff;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    .btn-row {
      margin: 8px 0 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button:active { transform: scale(0.98); }
    #saveBtn { background: #007aff; color: #fff; }
    #saveTargetBtn { background: #34c759; color: #fff; }
    #clearBtn { background: #f2f2f7; color: #333; }
    #status {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #666;
    }
    .stat-line {
      margin: 2px 0;
      font-size: 0.9rem;
    }
    .muted {
      color: #666;
      font-size: 0.85rem;
    }
    canvas {
      width: 100%;
      max-width: 600px;
      height: 260px;
    }
    #targetDiff.target-above {
      color: #d6336c;
    }
    #targetDiff.target-below {
      color: #2f9e44;
    }
  </style>
</head>
<body>
  <h1>体重记录小工具</h1>

  <div class="card">
    <label for="weightInput">今天体重（kg）：</label>
    <input type="number" id="weightInput" step="0.1" placeholder="例如 63.5" />

    <label for="targetInput" style="display:block;margin-top:6px;">目标体重（kg）：</label>
    <input type="number" id="targetInput" step="0.1" placeholder="例如 60" />

    <div class="btn-row">
      <button id="saveBtn">保存今天</button>
      <button id="saveTargetBtn">保存目标</button>
      <button id="clearBtn">清除所有数据</button>
    </div>

    <div id="status" class="muted"></div>
  </div>

  <div class="card">
    <h2 style="font-size:1.05rem;margin-top:0;">统计</h2>
    <div id="stats">
      <div class="stat-line">记录天数：<span id="daysCount">0</span></div>
      <div class="stat-line">最轻体重：<span id="minWeight">-</span></div>
      <div class="stat-line">最重体重：<span id="maxWeight">-</span></div>
      <div class="stat-line">平均体重：<span id="avgWeight">-</span></div>
      <div class="stat-line">总体变化：<span id="overallChange">-</span></div>
      <div class="stat-line">距离目标（当前 - 目标）：<span id="targetDiff">未设置</span></div>
      <div class="stat-line">最近 7 天变化：<span id="weekChange">-</span></div>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1.05rem;margin-top:0;">最近 30 天折线图</h2>
    <p class="muted">数据保存在本机浏览器（localStorage），不会上传网络。</p>
    <canvas id="chartCanvas"></canvas>
  </div>

  <script>
    const STORAGE_KEY = "weight-tracker-data-v1";
    const TARGET_KEY  = "weight-tracker-target-v1";

    function loadData() {
      try {
        const txt = localStorage.getItem(STORAGE_KEY);
        if (!txt) return [];
        const arr = JSON.parse(txt);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadTarget() {
      try {
        const txt = localStorage.getItem(TARGET_KEY);
        const v = parseFloat(txt);
        return isNaN(v) ? null : v;
      } catch {
        return null;
      }
    }

    function saveTarget(v) {
      localStorage.setItem(TARGET_KEY, String(v));
    }

    function formatDate(d) {
      return d.getFullYear() + "-" +
             String(d.getMonth()+1).padStart(2,"0") + "-" +
             String(d.getDate()).padStart(2,"0");
    }

    function renderStats(data) {
      const daysCountEl     = document.getElementById("daysCount");
      const minWeightEl     = document.getElementById("minWeight");
      const maxWeightEl     = document.getElementById("maxWeight");
      const avgWeightEl     = document.getElementById("avgWeight");
      const overallChangeEl = document.getElementById("overallChange");
      const weekChangeEl    = document.getElementById("weekChange");
      const targetDiffEl    = document.getElementById("targetDiff");

      if (!data.length) {
        daysCountEl.textContent     = "0";
        minWeightEl.textContent     = "-";
        maxWeightEl.textContent     = "-";
        avgWeightEl.textContent     = "-";
        overallChangeEl.textContent = "-";
        weekChangeEl.textContent    = "-";
        targetDiffEl.textContent    = "未设置";
        targetDiffEl.classList.remove("target-above", "target-below");
        drawChart([]);
        return;
      }

      data.sort((a,b) => a.date.localeCompare(b.date));
      const weights = data.map(d => d.weight);

      const sum = weights.reduce((a,b) => a + b, 0);
      const avg = sum / weights.length;
      const min = Math.min(...weights);
      const max = Math.max(...weights);
      const overallChange = weights[weights.length-1] - weights[0];

      daysCountEl.textContent     = String(data.length);
      minWeightEl.textContent     = min.toFixed(1) + " kg";
      maxWeightEl.textContent     = max.toFixed(1) + " kg";
      avgWeightEl.textContent     = avg.toFixed(1) + " kg";
      overallChangeEl.textContent = (overallChange >= 0 ? "+" : "") + overallChange.toFixed(1) + " kg";

      // 目标差值
      const target = loadTarget();
      targetDiffEl.classList.remove("target-above", "target-below");
      if (target != null) {
        const current = weights[weights.length-1];
        const diff = current - target;
        targetDiffEl.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(1) + " kg";
        if (diff > 0.05) {
          targetDiffEl.classList.add("target-above");
        } else if (diff < -0.05) {
          targetDiffEl.classList.add("target-below");
        }
      } else {
        targetDiffEl.textContent = "未设置";
      }

      // 最近 7 天
      if (data.length >= 7) {
        const base = weights[weights.length-7];
        const last = weights[weights.length-1];
        const diff = last - base;
        weekChangeEl.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(1) + " kg";
      } else {
        weekChangeEl.textContent = "记录少于 7 天";
      }

      drawChart(data.slice(-30));
    }

    function drawChart(data) {
      const canvas = document.getElementById("chartCanvas");
      const ctx = canvas.getContext("2d");
      const width  = canvas.clientWidth;
      const height = canvas.clientHeight;

      canvas.width  = width * window.devicePixelRatio;
      canvas.height = height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      ctx.clearRect(0,0,width,height);

      if (!data.length) {
        ctx.fillStyle = "#666";
        ctx.font = "14px -apple-system";
        ctx.fillText("暂无数据，先记录几天试试吧～", 10, 24);
        return;
      }

      const paddingLeft   = 30;
      const paddingRight  = 10;
      const paddingTop    = 10;
      const paddingBottom = 25;

      const xs = data.map((_,i) => i);
      const ys = data.map(d => d.weight);
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const rangeY = maxY - minY || 1;
      const maxX = xs.length - 1 || 1;

      function xToPx(x) {
        return paddingLeft + (x / maxX) * (width - paddingLeft - paddingRight);
      }

      function yToPx(y) {
        return paddingTop + (1 - (y - minY) / rangeY) *
               (height - paddingTop - paddingBottom);
      }

      // 坐标轴
      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, paddingTop);
      ctx.lineTo(paddingLeft, height - paddingBottom);
      ctx.lineTo(width - paddingRight, height - paddingBottom);
      ctx.stroke();

      // 折线
      ctx.strokeStyle = "#007aff";
      ctx.lineWidth = 2;
      ctx.beginPath();
      xs.forEach((x,i) => {
        const px = xToPx(x);
        const py = yToPx(ys[i]);
        if (i === 0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      });
      ctx.stroke();

      // 小圆点
      ctx.fillStyle = "#007aff";
      xs.forEach((x,i) => {
        const px = xToPx(x);
        const py = yToPx(ys[i]);
        ctx.beginPath();
        ctx.arc(px,py,3,0,Math.PI*2);
        ctx.fill();
      });

      // y 轴数字
      ctx.fillStyle = "#666";
      ctx.font = "11px -apple-system";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText(minY.toFixed(1), paddingLeft - 4, yToPx(minY));
      if (maxY !== minY) {
        ctx.fillText(maxY.toFixed(1), paddingLeft - 4, yToPx(maxY));
      }

      // x 轴日期（首尾）
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      const firstDate = data[0].date.slice(5);
      const lastDate  = data[data.length-1].date.slice(5);
      ctx.fillText(firstDate, xToPx(0), height - paddingBottom + 4);
      if (xs.length > 1) {
        ctx.fillText(lastDate, xToPx(maxX), height - paddingBottom + 4);
      }
    }

    function init() {
      const input        = document.getElementById("weightInput");
      const targetInput  = document.getElementById("targetInput");
      const saveBtn      = document.getElementById("saveBtn");
      const saveTargetBtn= document.getElementById("saveTargetBtn");
      const clearBtn     = document.getElementById("clearBtn");
      const statusEl     = document.getElementById("status");

      let data = loadData();
      renderStats(data);

      // 今天已有记录时自动填入
      const todayStr = formatDate(new Date());
      const todayRecord = data.find(d => d.date === todayStr);
      if (todayRecord) {
        input.value = todayRecord.weight;
      }

      // 加载目标体重
      const target = loadTarget();
      if (target != null && !isNaN(target)) {
        targetInput.value = target.toFixed(1);
      }

      saveBtn.addEventListener("click", () => {
        const v = parseFloat(input.value);
        if (isNaN(v)) {
          statusEl.textContent = "请输入数字格式的体重，例如 63.5";
          return;
        }
        const today = formatDate(new Date());
        const existing = data.find(d => d.date === today);
        if (existing) existing.weight = v;
        else data.push({ date: today, weight: v });
        data.sort((a,b)=>a.date.localeCompare(b.date));
        saveData(data);
        renderStats(data);
        statusEl.textContent = `已保存 ${today}：${v.toFixed(1)} kg`;
      });

      saveTargetBtn.addEventListener("click", () => {
        const v = parseFloat(targetInput.value);
        if (isNaN(v)) {
          statusEl.textContent = "请输入数字格式的目标体重，例如 60";
          return;
        }
        saveTarget(v);
        const latestData = loadData();
        renderStats(latestData);
        statusEl.textContent = `已保存目标体重：${v.toFixed(1)} kg`;
      });

      clearBtn.addEventListener("click", () => {
        if (!confirm("确定要清除所有记录吗？此操作不可恢复。")) return;
        data = [];
        saveData(data);
        renderStats(data);
        input.value = "";
        statusEl.textContent = "所有数据已清除。";
      });
    }

    window.addEventListener("load", init);
    window.addEventListener("resize", () => {
      const data = loadData();
      renderStats(data);
    });
  </script>
</body>
</html>
